name: Security Pipeline with SBOM and Dependency Scanning

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  build:
    name: Generate SBOM
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm ci
        npm install @cyclonedx/cyclonedx-npm@^2.0.0
    
    - name: Generate SBOM (CycloneDX format)
      run: npx @cyclonedx/cyclonedx-npm --output-file sbom.json
    
    - name: View SBOM contents
      run: |
        echo "=== SBOM Summary ==="
        echo "Total components: $(jq '.components | length' sbom.json 2>/dev/null || echo 'Install jq for better output')"
        cat sbom.json | head -100
        echo "..."
    
    - name: Upload SBOM as artifact
      uses: actions/upload-artifact@v4
      with:
        name: sbom-artifact
        path: sbom.json
        retention-days: 7

  security:
    name: Security Analysis
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download SBOM artifact
      uses: actions/download-artifact@v4
      with:
        name: sbom-artifact
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Install OWASP Dependency Check
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip
        wget https://github.com/jeremylong/DependencyCheck/releases/download/v9.0.9/dependency-check-9.0.9-release.zip
        unzip dependency-check-9.0.9-release.zip
        chmod +x ./dependency-check/bin/dependency-check.sh
    
    - name: Run OWASP Dependency Check Scan
      run: |
        ./dependency-check/bin/dependency-check.sh \
          --scan . \
          --format "HTML" \
          --format "JSON" \
          --out "reports" \
          --project "mephi-server" \
          --enableExperimental
    
    - name: Upload Dependency Check Reports
      uses: actions/upload-artifact@v4
      with:
        name: dependency-check-reports
        path: reports/
        retention-days: 7
    
    - name: Display vulnerability summary
      run: |
        if [ -f "reports/dependency-check-report.json" ]; then
          echo "=== Dependency Check Summary ==="
          echo "Report generated: $(ls -la reports/)"
          echo "JSON report exists"
          # Для простого проекта уязвимостей может не быть
          echo "Check the HTML report for details"
        else
          echo "No JSON report found"
        fi
    
    - name: Upload SBOM to Dependency Track (пример)
      if: false  # Отключено, так как нет доступа к Dependency Track
      run: |
        echo "This step would upload SBOM to Dependency Track"
        echo "For real usage, uncomment and configure with your Dependency Track URL and API key"
        # Пример команды:
        # curl -X "POST" "http://dependency-track-url/api/v1/bom" \
        #      -H "Content-Type: multipart/form-data" \
        #      -H "X-Api-Key: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}" \
        #      -F "bom=@sbom.json" \
        #      -F "projectName=mephi-server" \
        #      -F "projectVersion=1.0.0"
    
    - name: Analyze SBOM contents
      run: |
        echo "=== SBOM Analysis ==="
        echo "SBOM file size: $(wc -c < sbom.json) bytes"
        echo "SBOM contains:"
        if command -v jq &> /dev/null; then
          echo "- Format: $(jq -r '.bomFormat' sbom.json)"
          echo "- Spec version: $(jq -r '.specVersion' sbom.json)"
          echo "- Total dependencies: $(jq '.components | length' sbom.json)"
          echo "- Component types:"
          jq -r '.components[].type' sbom.json | sort | uniq -c
        else
          echo "Install jq for detailed analysis"
          grep -o '"type":"[^"]*"' sbom.json | sort | uniq -c
        fi

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Run application test
      run: |
        echo "Starting server..."
        node src/server.js &
        SERVER_PID=$!
        sleep 3
        
        echo "Running tests..."
        node test/server.test.js
        TEST_EXIT_CODE=$?
        
        echo "Stopping server..."
        pkill -f "node src/server.js" 2>/dev/null || true
        
        exit $TEST_EXIT_CODE

  deploy:
    needs: [build, security, test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download security reports
      uses: actions/download-artifact@v4
      with:
        name: dependency-check-reports
        path: security-reports/
    
    - name: Display deployment security status
      run: |
        echo "=== Deployment Security Check ==="
        echo "All security checks passed"
        echo "SBOM generated and analyzed"
        echo "Dependency Check completed"
        echo ""
        echo "Reports available as artifacts for 7 days"
    
    - name: Create deployment package
      run: |
        mkdir -p deployment
        cp -r src deployment/
        cp package.json deployment/
        cp sbom.json deployment/ 2>/dev/null || echo "SBOM not found"
        echo "Deployment time: $(date)" > deployment/deploy-info.txt
        echo "Security scan completed: Yes" >> deployment/deploy-info.txt
    
    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: deployment-package
        path: deployment/
        retention-days: 7