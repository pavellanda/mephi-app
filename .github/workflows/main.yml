name: CI/CD Practice Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Run application test
      run: |
        echo "Starting server..."
        node src/server.js &
        SERVER_PID=$!
        sleep 3
        
        echo "Running tests..."
        node test/server.test.js
        TEST_EXIT_CODE=$?
        
        echo "Stopping server..."
        # Обработка остановки процесса с учетом сборки на windows
        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
          taskkill /PID $SERVER_PID /F
        else
          kill $SERVER_PID 2>/dev/null || true
        fi
        
        exit $TEST_EXIT_CODE
    
    - name: Success message
      if: success()
      run: echo "Build and test completed successfully on ${{ matrix.os }}"
    
    - name: Failure message
      if: failure()
      run: echo "Build or test failed on ${{ matrix.os }}"

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Simulate deployment
      run: |
        echo "Starting deployment simulation..."
        echo "Previous jobs completed successfully"
        echo "Application is ready for deployment"
        echo ""
        echo "Deployment summary:"
        echo "  - Platform: Linux (Ubuntu)"
        echo "  - Status: Ready"
        echo "  - Next steps: Configure real deployment"
        echo ""
        echo "CI/CD pipeline practice completed!"
    
    - name: Create deployment artifact
      run: |
        echo "Creating deployment package..."
        mkdir -p deployment
        cp -r src deployment/
        cp package.json deployment/
        echo "Deployment time: $(date)" > deployment/deploy-info.txt
        
        echo "Artifact contents:"
        ls -la deployment/
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: deploy-package
        path: deployment/