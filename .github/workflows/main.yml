name: Github Actions Practice Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # build - Всегда (и PR, и push в main)
  build:
    name: Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build verification
      run: |
        echo "Build completed successfully"
        echo "Node.js version: $(node --version)"
        echo "npm version: $(npm --version)"
        echo "Project dependencies installed"
    
    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: build-artifact
        path: |
          package.json
          package-lock.json
          src/
        retention-days: 7

  # security - только для PR
  security:
    name: Security Analysis
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'  # только для PR
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Install dependencies
      run: npm ci
    
    # Часть 1: Генерация SBOM
    - name: Install SBOM tools
      run: |
        npm install -g @cyclonedx/cyclonedx-npm
        npm install @cyclonedx/cyclonedx-npm --save-dev
    
    - name: Generate CycloneDX SBOM
      run: |
        npx @cyclonedx/cyclonedx-npm --output-file sbom-cyclonedx.json
        echo "SBOM generated successfully"
        echo "Total dependencies found: $(jq '.components | length' sbom-cyclonedx.json)"
        echo ""
        echo "=== Dependencies List ==="
        jq -r '.components[] | select(.type == "library") | "\(.name)@\(.version)"' sbom-cyclonedx.json
    
    # OWASP Dependency Check
    - name: Run OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'mephi-server'
        path: '.'
        format: 'HTML'
        out: 'reports'
        args: >
          --enableExperimental
          --failOnCVSS 0
          --scan .
    
    - name: Process Dependency Check results
      run: |
        echo "=== Dependency Check Results ==="
        if [ -f "reports/dependency-check-report.html" ]; then
          echo "Report generated: reports/dependency-check-report.html"
          
          # Если есть JSON отчет, анализируем его
          if [ -f "reports/dependency-check-report.json" ]; then
            VULN_COUNT=$(jq '[.dependencies[].vulnerabilities[]?] | length' reports/dependency-check-report.json 2>/dev/null || echo "0")
            echo "Found $VULN_COUNT vulnerabilities"
          fi
        else
          echo "No Dependency Check report found"
        fi
    
    # Dependency Track эмуляция
    - name: Simulate Dependency Track analysis
      run: |
        echo "=== Dependency Track Simulation ==="
        echo ""
        echo "Local analysis of dependencies:"
        echo ""
        
        # Анализ через npm audit
        npm audit --json > npm-audit.json 2>/dev/null || true
        
        if [ -f "npm-audit.json" ]; then
          AUDIT_VULNS=$(jq -r '.metadata.vulnerabilities.total // 0' npm-audit.json)
          echo "npm audit found $AUDIT_VULNS vulnerabilities"
          
          if [ "$AUDIT_VULNS" -gt 0 ]; then
            echo ""
            echo "Vulnerability breakdown:"
            jq -r '.metadata.vulnerabilities | to_entries[] | "\(.key): \(.value)"' npm-audit.json
          fi
        fi
        
        echo ""
        echo "Manual dependency check:"
        # Проверка конкретных версий
        grep -q '"express".*"4.17.1"' sbom-cyclonedx.json && echo "express@4.17.1 - Known vulnerabilities"
        grep -q '"lodash".*"4.17.15"' sbom-cyclonedx.json && echo "lodash@4.17.15 - Known vulnerabilities"
        grep -q '"moment".*"2.29.1"' sbom-cyclonedx.json && echo "moment@2.29.1 - Known vulnerabilities"
    
    # Сохранение отчетов
    - name: Upload security artifacts
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          sbom-cyclonedx.json
          reports/
          npm-audit.json
        retention-days: 7
    
    - name: Generate security summary
      run: |
        echo "# Security Analysis Summary" > security-summary.md
        echo "**Date:** $(date)" >> security-summary.md
        echo "**PR:** #${{ github.event.pull_request.number }}" >> security-summary.md
        echo "" >> security-summary.md
        echo "## Tools Executed" >> security-summary.md
        echo "- SBOM Generation (CycloneDX)" >> security-summary.md
        echo "- OWASP Dependency Check" >> security-summary.md
        echo "- Dependency Track Simulation" >> security-summary.md
        echo "" >> security-summary.md
        echo "## Reports Available" >> security-summary.md
        echo "- sbom-cyclonedx.json" >> security-summary.md
        echo "- dependency-check-report.html" >> security-summary.md
        echo "- npm-audit.json" >> security-summary.md
        echo "" >> security-summary.md
        echo "## Next Steps" >> security-summary.md
        echo "1. Review security reports" >> security-summary.md
        echo "2. Fix identified vulnerabilities" >> security-summary.md
        echo "3. Approve merge after review" >> security-summary.md
        
        cat security-summary.md
    
    - name: Upload summary
      uses: actions/upload-artifact@v4
      with:
        name: security-summary
        path: security-summary.md
        retention-days: 7

  # test - всегда (зависит от security только в PR)
  test:
    name: Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    # Условная зависимость: если это PR, ждем security, если push - только build
    if: |
      (github.event_name == 'pull_request' && needs.security.result == 'success') ||
      (github.event_name == 'push')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Run application tests
      shell: bash
      run: |
        echo "Starting server..."
        node src/server.js &
        SERVER_PID=$!
        sleep 3
        
        echo "Running tests..."
        node test/server.test.js
        TEST_EXIT_CODE=$?
        
        echo "Stopping server..."
        pkill -f "node src/server.js" 2>/dev/null || true
        
        exit $TEST_EXIT_CODE
    
    - name: Success message
      if: success()
      run: echo "Tests completed successfully on ${{ matrix.os }}"
    
    - name: Failure message
      if: failure()
      run: echo "Tests failed on ${{ matrix.os }}"

  # deploy - Только для push в main
  deploy:
    name: Deploy
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: deployment
      run: |
        echo "DEPLOYMENT PROCESS"
        echo ""
        echo "=== Deployment Summary ==="
        echo "Branch: ${{ github.ref }}"
        echo "Commit: ${{ github.sha }}"
        echo "Author: ${{ github.actor }}"
        echo ""
        
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          echo "Security checks completed during PR review:"
          echo "SBOM generated"
          echo "Vulnerability analysis"
          echo "All tests passed"
        else
          echo "Direct push to main - security checks not required"
          echo "Build completed"
          echo "Tests passed"
        fi
        
        echo ""
        echo "=== Deployment Steps ==="
        echo "1. Creating deployment package..."
        mkdir -p deployment
        cp -r src deployment/
        cp package*.json deployment/
        cp README.md deployment/ 2>/dev/null || true
        
        echo "2. Generating deployment manifest..."
        echo "Deployment Time: $(date)" > deployment/deploy-info.txt
        echo "Commit SHA: ${{ github.sha }}" >> deployment/deploy-info.txt
        echo "Build ID: ${{ github.run_id }}" >> deployment/deploy-info.txt
        
        echo "3. Package contents:"
        ls -la deployment/
        
        echo ""
        echo "Deployment package ready!"
        echo ""
        echo "Next steps (in production):"
        echo "• Upload to server"
        echo "• Run database migrations"
        echo "• Restart services"
        echo "• Health checks"
    
    - name: Create deployment artifact
      run: |
        echo "Creating final deployment artifact..."
        tar -czf deployment-package.tar.gz deployment/
        echo "Artifact size: $(du -h deployment-package.tar.gz | cut -f1)"
    
    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: deploy-package
        path: |
          deployment/
          deployment-package.tar.gz
        retention-days: 7